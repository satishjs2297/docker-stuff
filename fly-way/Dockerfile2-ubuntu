# -------- Stage 1: Build Postgres & Flyway --------
FROM ubuntu:22.04 AS builder

ARG POSTGRES_VERSION=16.4
ARG FLYWAY_VERSION=10.19.0

RUN apt-get update && apt-get install -y \
    build-essential \
    libreadline-dev \
    zlib1g-dev \
    curl \
    unzip \
    openjdk-17-jdk \
    && rm -rf /var/lib/apt/lists/*

# Build PostgreSQL from source
RUN curl -L https://ftp.postgresql.org/pub/source/v${POSTGRES_VERSION}/postgresql-${POSTGRES_VERSION}.tar.gz -o postgres.tar.gz \
    && tar -xzf postgres.tar.gz \
    && cd postgresql-${POSTGRES_VERSION} \
    && ./configure --prefix=/usr/local/pgsql \
    && make && make install

# Download Flyway
RUN curl -L "https://repo1.maven.org/maven2/org/flywaydb/flyway-commandline/${FLYWAY_VERSION}/flyway-commandline-${FLYWAY_VERSION}-linux-x64.tar.gz" -o flyway.tar.gz \
    && tar -xzf flyway.tar.gz \
    && mv flyway-${FLYWAY_VERSION} /flyway

# -------- Stage 2: Minimal Runtime --------
FROM gcr.io/distroless/java17-debian12:nonroot

ENV PATH=/usr/local/pgsql/bin:/flyway:$PATH \
    PGDATA=/var/lib/postgresql/data \
    POSTGRES_USER=flyway_user \
    POSTGRES_PASSWORD=flyway_pass \
    POSTGRES_DB=flyway_db

COPY --from=builder /usr/local/pgsql /usr/local/pgsql
COPY --from=builder /flyway /flyway

# Add entrypoint
COPY docker-entrypoint.sh /usr/local/bin/
WORKDIR /flyway/sql
EXPOSE 5432

ENTRYPOINT ["/usr/local/bin/docker-entrypoint.sh"]
